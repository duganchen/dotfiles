#!/usr/bin/env bash

# vidthumb /path/to/movie.ext
# Outputs the path to movie.ext's thumbnail, which would be generated and cached if
# necessary.

# All data is stored in ~/.cache/vidthumb/.

if ! [ -f "$1" ]; then
	exit 1
fi

if [[ "$( file -b --mime-type "$1" )" != video/* ]]; then
	exit 1
fi

cache="$HOME/.cache/vidthumb"
index="$HOME/.cache/vidthumb/index.json"
movie="$(realpath "$1")"
thumbnail=""

mkdir -p "$cache"

if [ -f "$index" ]; then
	thumbnail="$(jq -r ". \"$movie\"" <"$index")"
	if [[ "$thumbnail" == "null" ]]; then
		thumbnail="$cache/$(uuidgen).jpg"
		json="$(jq -r --arg "$movie" "$thumbnail" ". + {\"$movie\": \"$thumbnail\"}" <"$index")"
		echo "$json" >"$index"
	fi
else
	thumbnail="$cache/$(uuidgen).jpg"
	echo "{\"$movie\": \"$thumbnail\"}" >"$index"
fi

if [ ! -f "$thumbnail" ]; then
	ffmpegthumbnailer -i "$movie" -o "$thumbnail" -s 0
fi

echo "$thumbnail"
